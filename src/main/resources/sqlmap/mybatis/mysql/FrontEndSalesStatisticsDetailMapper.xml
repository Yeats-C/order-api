<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiqin.mgs.order.api.dao.FrontEndSalesStatisticsDetailDao">
    <resultMap id="BaseResultMap" type="com.aiqin.mgs.order.api.domain.statistical.FrontEndSalesStatisticsDetail">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="sale_statistics_id" jdbcType="VARCHAR" property="saleStatisticsId"/>
        <result column="sale_statistics_detail_id" jdbcType="VARCHAR" property="saleStatisticsDetailId"/>
        <result column="store_id" jdbcType="VARCHAR" property="storeId"/>
        <result column="order_detail_id" jdbcType="VARCHAR" property="orderDetailId"/>
        <result column="sku_code" jdbcType="VARCHAR" property="skuCode"/>
        <result column="sku_name" jdbcType="VARCHAR" property="skuName"/>
        <result column="day" jdbcType="INTEGER" property="day"/>
        <result column="category_id" jdbcType="VARCHAR" property="categoryId"/>
        <result column="category_name" jdbcType="VARCHAR" property="categoryName"/>
        <result column="sale_total_count" jdbcType="BIGINT" property="saleTotalCount"/>
        <result column="sale_total_amount" jdbcType="BIGINT" property="saleTotalAmount"/>
        <result column="price_unit" jdbcType="INTEGER" property="priceUnit"/>
        <result column="sku_unit" jdbcType="VARCHAR" property="skuUnit"/>
        <result column="create_time" jdbcType="TIMESTAMP"
                property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP"
                property="updateTime"/>
        <result column="create_by" jdbcType="VARCHAR"
                property="createBy"/>
        <result column="update_by" jdbcType="VARCHAR"
                property="updateBy"/>
    </resultMap>
    <sql id="Base_Column_List">
        t0.id as id,
        t0.sale_statistics_id as saleStatisticsId,
        t0.sale_statistics_detail_id as saleStatisticsDetailId,
        t0.store_id as storeId,
        t0.order_detail_id as orderDetailId,
        t0.sku_code as skuCode,
        t0.sku_name as skuName,
        t0.day as day,
        t0.category_id as categoryId,
        t0.category_name as categoryName,
        t0.sale_total_count as saleTotalCount,
        t0.sale_total_amount as saleTotalAmount,
        t0.price_unit as priceUnit,
        t0.sku_unit as skuUnit,
        t0.create_time as createTime,
        t0.update_time as updateTime,
        t0.create_by as createBy,
        t0.update_by as updateBy
    </sql>
    <sql id="where_Column_List">
        <if test="storeId != null">
            and store_id = #{storeId,jdbcType=VARCHAR}
        </if>

        <if test="day != null">
            and month =
            #{day,jdbcType=VARCHAR}
        </if>
    </sql>

    <!-- 查询前台销售统计情况 -->
    <select id="selectStoreMonthSaleStatisticsByMonthAndStoreId"
    resultType="com.aiqin.mgs.order.api.domain.dto.FrontEndSalesStatisticsResponse">
        select
            t0.store_id as storeId,
            t0.sku_code as skuCode,
            t0.sku_name as skuName,
            t0.category_id as categoryId,
            t0.category_name as categoryName,
            sum(t0.sale_total_count) as saleTotalCount,
            sum(t0.sale_total_amount) as saleTotalAmount,
            t0.price_unit as priceUnit,
            t0.sku_unit as skuUnit
        from front_end_sales_statistics_detail t0
        where
            store_id = #{storeId,jdbcType=VARCHAR}
            and day BETWEEN #{beginDay,jdbcType=INTEGER} and #{currentDay,jdbcType=INTEGER}
        group by store_id ,sku_code, category_id
    </select>


    <select id="selectYesterdaySalesStatistics"
            resultType="com.aiqin.mgs.order.api.domain.statistical.FrontEndSalesStatisticsDetail">
        select DISTINCT
            t1.distributor_id as storeId,
            t0.order_detail_id as orderDetailId,
            t0.unit as skuUnit,
            ifnull(sum(t0.retail_price * ifnull(t0.amount,0)),0)  as saleTotalAmount,
            ifnull(sum(amount),0) as saleTotalCount,
            t0.type_id as categoryId,
            t0.type_name as categoryName,
            t0.sku_code as skuCode,
            t0.sku_name as skuName,
            DATE_FORMAT( t1.create_time, '%Y%m%d' ) as day
        from order_consumer_detail t0
            LEFT JOIN order_consumer_info t1
            on t0.order_id = t1.order_id
        WHERE
            DATE_FORMAT( t1.create_time, '%Y%m%d' ) = DATE_FORMAT( ADDDATE(CURDATE(), INTERVAL -1 DAY) , '%Y%m%d' )
        group by
            t1.distributor_id ,
            t0.sku_code,
            t0.type_id
    </select>

    <insert id="insertSalesStatisticsDetailList" parameterType="java.util.List">
        insert into front_end_sales_statistics_detail
        (
            sale_statistics_id,
            sale_statistics_detail_id,
            store_id,
            order_detail_id,
            sku_code,
            sku_name,
            day,
            category_id,
            category_name,
            sale_total_count,
            sale_total_amount,
            price_unit,
            sku_unit,
            create_time,
            update_time,
            create_by,
            update_by
        )
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.saleStatisticsId},
            #{item.saleStatisticsDetailId},
            #{item.storeId},
            #{item.orderDetailId},
            #{item.skuCode},
            #{item.skuName},
            #{item.day},
            #{item.categoryId},
            #{item.categoryName},
            #{item.saleTotalCount},
            #{item.saleTotalAmount},
            #{item.priceUnit},
            #{item.skuUnit},
            now(),
            now(),
            #{item.createBy},
            #{item.updateBy}
            )
        </foreach>
    </insert>

</mapper>

